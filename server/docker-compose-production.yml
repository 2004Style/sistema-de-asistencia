version: '3.8'

services:
  # ============================================
  # API FastAPI - SIN PostgreSQL local
  # ============================================
  api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: sistema-asistencia-api
    hostname: api
    # Cargar archivo .env.production
    env_file:
      - .env.production
    environment:
      # Las variables se cargan automáticamente del .env.production
      # Solo sobrescribimos los valores que deben ser diferentes en producción
      AUTO_MIGRATE: "false"
      DEBUG: "false"
    
    ports:
      # IMPORTANTE: API solo se expone en puerto 8000 (para desarrollo)
      # En producción, Nginx es el único accesible en puerto 80/443
      - "8000:8000"
    
    volumes:
      - ./public:/app/public
      - ./recognize/data:/app/recognize/data
    
    networks:
      - sistema-asistencia-network
    
    restart: unless-stopped
    
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health').read()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 45s

  # ============================================
  # Nginx - Reverse Proxy (ÚNICO acceso público)
  # ============================================
  nginx:
    image: nginx:alpine
    container_name: sistema-asistencia-nginx
    hostname: nginx
    
    # ACCESO AL SERVICIO
    ports:
      - "${NGINX_HTTP_PORT:-80}:80"                    # HTTP
      - "${NGINX_HTTPS_PORT:-443}:443"                 # HTTPS
    
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./certs:/etc/nginx/certs:ro
    
    depends_on:
      api:
        condition: service_healthy
    
    networks:
      - sistema-asistencia-network
    
    restart: unless-stopped
    
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost/health').read()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

networks:
  sistema-asistencia-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

# NOTA: Base de datos está en servidor externo
# La conexión se configura via DATABASE_URL en .env.production
