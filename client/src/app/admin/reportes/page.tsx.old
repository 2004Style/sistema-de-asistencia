"use client";

import { useState, useEffect } from "react";
import { useReportesApi } from "@/hooks/useReportesApi.hook";
import { ResportesList } from "@/interfaces";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { Alert, AlertDescription, AlertTitle } from "@/components/ui/alert";
import { Loader2, AlertCircle, Download, Trash2, FileText, Calendar } from "lucide-react";
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogTitle,
} from "@/components/ui/alert-dialog";

// Definición de columnas para la tabla de reportes
const createColumns = (tableActions: ReturnType<typeof useTableActions<ResportesList>>): ColumnDef<ResportesList>[] => [
    {
        accessorKey: "id",
        header: ({ column }) => <SortableHeader column={column} title="ID" />,
        cell: ({ row }) => (
            <div className="font-mono text-xs">{row.getValue("id")}</div>
        ),
    },
    {
        accessorKey: "nombre",
        header: ({ column }) => <SortableHeader column={column} title="Nombre" />,
        cell: ({ row }) => (
            <div className="font-medium">{row.getValue("nombre")}</div>
        ),
    },
    {
        accessorKey: "ruta",
        header: ({ column }) => <SortableHeader column={column} title="Ruta" />,
        cell: ({ row }) => (
            <div className="font-medium truncate max-w-xs">{row.getValue("ruta")}</div>
        ),
    },
    {
        accessorKey: "tipo",
        header: ({ column }) => <SortableHeader column={column} title="Tipo" />,
        cell: ({ row }) => (
            <div className="font-medium">{row.getValue("tipo")}</div>
        ),
    },
    {
        accessorKey: "formato",
        header: ({ column }) => <SortableHeader column={column} title="Formato" />,
        cell: ({ row }) => {
            const formato = row.getValue("formato") as string;
            return (
                <Badge className="gap-1">{formato?.toUpperCase()}</Badge>
            );
        },
    },
    {
        accessorKey: "tamano",
        header: ({ column }) => <SortableHeader column={column} title="Tamaño (bytes)" />,
        cell: ({ row }) => {
            const tamano = row.getValue("tamano") as number;
            return (
                <div className="font-medium">{tamano ?? 0}</div>
            );
        },
    },
    {
        accessorKey: "fecha_creacion",
        header: ({ column }) => <SortableHeader column={column} title="Fecha Creación" />,
        cell: ({ row }) => {
            const fecha = row.getValue("fecha_creacion") as string;
            return (
                <div className="font-medium text-xs">{fecha}</div>
            );
        },
    },
    {
        accessorKey: "url_descarga",
        header: ({ column }) => <SortableHeader column={column} title="URL Descarga" />,
        cell: ({ row }) => {
            const url = row.getValue("url_descarga") as string;
            return (
                <a href={url} target="_blank" rel="noreferrer" className="text-sm text-foreground underline">Abrir</a>
            );
        },
    },
    {
        id: "actions",
        header: "Acciones",
        enableHiding: false,
        cell: ({ row }) => {
            const item = row.original;

            return (
                <TableActionsMenu
                    item={item}
                    onCopyId={tableActions.handleCopyId}
                    onViewDetails={tableActions.handleViewDetails}
                    onEdit={tableActions.handleEdit}
                    onDelete={tableActions.openDeleteDialog}
                    copyIdLabel="Copiar ID de reporte"
                />
            );
        },
    },
];

export default function ReportesPage() {
    const {
        data: roles,
        isLoading,
        tableState,
        totalPages,
        totalRecords,
        setPage,
        setPageSize,
        setSearch,
        setSorting,
        refresh,
    } = useServerTable<ResportesList>({
        endpoint: BACKEND_ROUTES.urlReportesList,
        initialPageSize: 15,
    });

    const tableActions = useTableActions<ResportesList>({
        resourceName: "reporte",
        deleteEndpoint: (id) => `${BACKEND_ROUTES.urlReportesList}/${id}`,
        editRoute: (id) => `/admin/reporte/${id}/edit`,
        detailRoute: (id) => `/admin/reporte/${id}`,
        onDeleteSuccess: refresh,
    });

    // --- Formulario de generar reportes (movido aquí) ---
    const api = useClientApi(true)
    type ReportType = "diario" | "semanal" | "mensual" | "tardanzas" | "inasistencias"

    const [tipo, setTipo] = useState<ReportType>("diario")
    const [userId, setUserId] = useState<number | undefined>(undefined)
    const [formato, setFormato] = useState<string>("both")
    const [enviarEmail, setEnviarEmail] = useState<boolean>(false)
    const [fecha, setFecha] = useState<string>(new Date().toISOString().slice(0, 10))
    const [fechaInicio, setFechaInicio] = useState<string>(new Date().toISOString().slice(0, 10))
    const [fechaFin, setFechaFin] = useState<string>(new Date().toISOString().slice(0, 10))
    const [anio, setAnio] = useState<number>(new Date().getFullYear())
    const [mes, setMes] = useState<number>(new Date().getMonth() + 1)
    const [loadingGenerate, setLoadingGenerate] = useState(false)
    const [message, setMessage] = useState<string | null>(null)
    const [messageKind, setMessageKind] = useState<"success" | "error" | "info" | null>(null)

    const buildQuery = (params: Record<string, any>) => {
        const esc = encodeURIComponent
        return Object.keys(params)
            .filter((k) => params[k] !== undefined && params[k] !== null && params[k] !== "")
            .map((k) => `${esc(k)}=${esc(String(params[k]))}`)
            .join("&")
    }

    const handleGenerate = async () => {
        try {
            setLoadingGenerate(true)
            setMessage(null)

            let path = "/reportes/diario"
            let params: Record<string, any> = {}

            switch (tipo) {
                case "diario":
                    path = "/reportes/diario"
                    params = { fecha, user_id: userId, formato, enviar_email: enviarEmail }
                    break
                case "semanal":
                    path = "/reportes/semanal"
                    params = { fecha_inicio: fechaInicio, user_id: userId, formato, enviar_email: enviarEmail }
                    break
                case "mensual":
                    path = "/reportes/mensual"
                    params = { anio, mes, user_id: userId, formato, enviar_email: enviarEmail }
                    break
                case "tardanzas":
                    path = "/reportes/tardanzas"
                    params = { fecha_inicio: fechaInicio, fecha_fin: fechaFin, user_id: userId, formato, enviar_email: enviarEmail }
                    break
                case "inasistencias":
                    path = "/reportes/inasistencias"
                    params = { fecha_inicio: fechaInicio, fecha_fin: fechaFin, user_id: userId, formato, enviar_email: enviarEmail }
                    break
                default:
                    break
            }

            const query = buildQuery(params)
            const url = `${path}?${query}`

            const res = await api.get<any>(url)

            if (res.alert === "success") {
                setMessageKind("success")
                setMessage(res.message || "Reporte generado")
                // refrescar la tabla para mostrar nuevos reportes
                refresh()
            } else {
                setMessageKind("error")
                setMessage(res.message || "Error generando reporte")
            }
        } catch (err: any) {
            setMessageKind("error")
            setMessage(err?.message || String(err))
        } finally {
            setLoadingGenerate(false)
        }
    }

    const columns = createColumns(tableActions);

    return (
        <div className="container mx-auto py-6 px-4 md:py-10">
            <div className="mb-6 w-full">
                <div>
                    <h1 className="text-3xl font-bold tracking-tight">Reportes</h1>
                    <p className="text-muted-foreground">Visualiza y gestiona los Reportes del sistema</p>
                </div>

                {/* Redesigned: Formulario de creación de reportes (integrado) */}
                <section className="mt-6 p-6 border rounded-lg bg-card">
                    <div className="flex items-start justify-between gap-6 md:gap-8">
                        <div className="flex-1">
                            <div className="flex items-center justify-between">
                                <div>
                                    <h2 className="text-lg font-semibold">Generar reporte</h2>
                                    <p className="text-sm text-muted-foreground">Selecciona opciones y genera el reporte deseado</p>
                                </div>
                                <div className="hidden md:flex items-center gap-3">
                                    <span className="text-xs text-muted-foreground">Estado</span>
                                    <span className={`inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${messageKind === 'success' ? 'bg-emerald-100 text-emerald-800' : messageKind === 'error' ? 'bg-destructive/10 text-destructive' : 'bg-muted'}`}>{messageKind === 'success' ? 'Último OK' : messageKind === 'error' ? 'Último error' : 'Listo'}</span>
                                </div>
                            </div>

                            <div className="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div>
                                    <label className="text-sm">Tipo</label>
                                    <Select onValueChange={(v) => setTipo(v as ReportType)} defaultValue={tipo}>
                                        <SelectTrigger>
                                            <SelectValue />
                                        </SelectTrigger>
                                        <SelectContent>
                                            <SelectItem value="diario">Diario</SelectItem>
                                            <SelectItem value="semanal">Semanal</SelectItem>
                                            <SelectItem value="mensual">Mensual</SelectItem>
                                            <SelectItem value="tardanzas">Tardanzas</SelectItem>
                                            <SelectItem value="inasistencias">Inasistencias</SelectItem>
                                        </SelectContent>
                                    </Select>
                                </div>

                                <div>
                                    <label className="text-sm">Usuario (opcional)</label>
                                    <UserCombobox onValueChange={(id) => setUserId(id)} />
                                </div>
                            </div>

                            {/* Campos condicionales */}
                            <div className="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-4">
                                {tipo === "diario" && (
                                    <div>
                                        <label className="text-sm">Fecha</label>
                                        <Input type="date" value={fecha} onChange={(e) => setFecha(e.target.value)} />
                                    </div>
                                )}

                                {tipo === "semanal" && (
                                    <div>
                                        <label className="text-sm">Fecha inicio</label>
                                        <Input type="date" value={fechaInicio} onChange={(e) => setFechaInicio(e.target.value)} />
                                    </div>
                                )}

                                {tipo === "mensual" && (
                                    <>
                                        <div>
                                            <label className="text-sm">Año</label>
                                            <Input type="number" value={anio} onChange={(e) => setAnio(Number(e.target.value))} />
                                        </div>
                                        <div>
                                            <label className="text-sm">Mes</label>
                                            <Select onValueChange={(v) => setMes(Number(v))} defaultValue={String(mes)}>
                                                <SelectTrigger>
                                                    <SelectValue />
                                                </SelectTrigger>
                                                <SelectContent>
                                                    {["", "Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"].map((mName, idx) => (
                                                        idx === 0 ? null : <SelectItem key={idx} value={String(idx)}>{mName}</SelectItem>
                                                    ))}
                                                </SelectContent>
                                            </Select>
                                        </div>
                                    </>
                                )}

                                {(tipo === "tardanzas" || tipo === "inasistencias") && (
                                    <>
                                        <div>
                                            <label className="text-sm">Fecha inicio</label>
                                            <Input type="date" value={fechaInicio} onChange={(e) => setFechaInicio(e.target.value)} />
                                        </div>
                                        <div>
                                            <label className="text-sm">Fecha fin</label>
                                            <Input type="date" value={fechaFin} onChange={(e) => setFechaFin(e.target.value)} />
                                        </div>
                                    </>
                                )}
                            </div>

                            {/* Formato + Email + Acción */}
                            <div className="mt-5 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                                <div className="flex items-center gap-4">
                                    <div className="flex items-center gap-2">
                                        <span className="text-sm">Formato</span>
                                        <div className="inline-flex items-center gap-2 bg-muted rounded-full px-2 py-1">
                                            {[
                                                { key: 'pdf', label: 'PDF' },
                                                { key: 'excel', label: 'Excel' },
                                                { key: 'both', label: 'Ambos' },
                                            ].map((f) => (
                                                <button
                                                    key={f.key}
                                                    type="button"
                                                    onClick={() => setFormato(f.key)}
                                                    className={`px-3 py-1 text-xs rounded-full font-medium transition ${formato === f.key ? 'bg-primary text-primary-foreground shadow-sm' : 'hover:bg-muted/50'}`}
                                                >
                                                    {f.label}
                                                </button>
                                            ))}
                                        </div>
                                    </div>

                                    <div className="flex items-center gap-3">
                                        <div
                                            role="switch"
                                            tabIndex={0}
                                            aria-checked={enviarEmail}
                                            onClick={() => setEnviarEmail(!enviarEmail)}
                                            onKeyDown={(e) => {
                                                if (e.key === "Enter" || e.key === " ") {
                                                    e.preventDefault()
                                                    setEnviarEmail(!enviarEmail)
                                                }
                                            }}
                                            className={`relative w-14 h-8 rounded-full transition-colors duration-200 cursor-pointer ${enviarEmail ? 'bg-emerald-500' : 'bg-gray-300 dark:bg-gray-600'}`}
                                        >
                                            <span className={`absolute left-1 top-1 w-6 h-6 bg-white rounded-full shadow transform transition-transform duration-200 ${enviarEmail ? 'translate-x-6' : 'translate-x-0'}`} />
                                        </div>
                                        <div className="flex flex-col">
                                            <span className="text-sm font-medium">Enviar por email</span>
                                            <span className="text-xs text-muted-foreground">{enviarEmail ? 'Se enviará automáticamente' : 'No se enviará'}</span>
                                        </div>
                                    </div>
                                </div>

                                <div className="flex items-center gap-3">
                                    <Button onClick={handleGenerate} disabled={loadingGenerate} className="flex items-center gap-2">
                                        {loadingGenerate ? 'Generando...' : 'Generar reporte'}
                                        <span className="ml-1">
                                            <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="7 10 12 15 17 10" /><line x1="12" y1="15" x2="12" y2="3" /></svg>
                                        </span>
                                    </Button>
                                </div>
                            </div>
                        </div>

                        <aside className="hidden md:block md:w-1/3 p-4 bg-muted rounded-md">
                            <h3 className="text-sm font-semibold">Resumen</h3>
                            <p className="text-xs text-muted-foreground mt-2">Vista previa rápida de lo que se generará</p>

                            <div className="mt-4 space-y-2">
                                <div className="flex items-center justify-between">
                                    <span className="text-sm text-muted-foreground">Tipo</span>
                                    <span className="text-sm font-medium">{tipo}</span>
                                </div>
                                <div className="flex items-center justify-between">
                                    <span className="text-sm text-muted-foreground">Usuario</span>
                                    <span className="text-sm font-medium">{userId ?? 'Todos'}</span>
                                </div>
                                <div className="flex items-center justify-between">
                                    <span className="text-sm text-muted-foreground">Formato</span>
                                    <span className="text-sm font-medium">{formato.toUpperCase()}</span>
                                </div>
                                <div className="flex items-center justify-between">
                                    <span className="text-sm text-muted-foreground">Enviar email</span>
                                    <span className="text-sm font-medium">{enviarEmail ? 'Sí' : 'No'}</span>
                                </div>
                            </div>
                        </aside>
                    </div>

                    {message && (
                        <div className="mt-5">
                            <Alert variant={messageKind === "error" ? "destructive" : "default"}>
                                <AlertTitle>{messageKind === "error" ? "Error" : "OK"}</AlertTitle>
                                <AlertDescription>{message}</AlertDescription>
                            </Alert>
                        </div>
                    )}
                </section>
            </div>

            <DataTable
                columns={columns}
                data={roles}
                isLoading={isLoading}
                searchPlaceholder="Buscar por nombre o descripción..."
                currentPage={tableState.page}
                totalPages={totalPages}
                totalRecords={totalRecords}
                pageSize={tableState.pageSize}
                searchValue={tableState.search}
                onPageChange={setPage}
                onPageSizeChange={setPageSize}
                onSearchChange={setSearch}
                onSortingChange={setSorting}
                pageSizeOptions={[10, 15, 25, 50]}
            />

            <DeleteConfirmationDialog
                open={tableActions.isDeleteDialogOpen}
                onOpenChange={tableActions.closeDeleteDialog}
                onConfirm={tableActions.handleDelete}
                title="¿Eliminar reporte?"
                description="Esta acción no se puede deshacer. Esto eliminará permanentemente el reporte del sistema."
                itemName={tableActions.itemToDelete?.nombre || tableActions.itemToDelete?.id || ""}
                isLoading={tableActions.isDeleting}
            />
        </div>
    );
}